chrome.runtime.onConnect.addListener(a=>{a.name==="agent"&&a.onMessage.addListener(async e=>{try{if((e==null?void 0:e.type)==="user_message"){const t=e.text??"",n=await g(t);a.postMessage({type:"assistant_message",text:n})}else if((e==null?void 0:e.type)==="traverse_tabs"){const t=await x();a.postMessage({type:"assistant_message",text:t})}}catch(t){a.postMessage({type:"assistant_message",text:(t==null?void 0:t.message)||"Error"})}})});chrome.runtime.onMessage.addListener((a,e,t)=>{var n;if((a==null?void 0:a.type)==="summarize_current_tab"){const r=(n=e.tab)==null?void 0:n.id;return r?(chrome.tabs.sendMessage(r,{type:"get_page_text"},i=>{if(!(i!=null&&i.ok))return t(i);t({ok:!0,title:i.title,text:i.text})}),!0):(t({ok:!1,error:"No active tab"}),!0)}});async function g(a){var s,c,u,l,y,d;try{if("ai"in globalThis&&((s=globalThis.ai)!=null&&s.createTextSession))return await(await globalThis.ai.createTextSession({temperature:.2})).prompt(a)}catch{}const{geminiApiKey:e}=await chrome.storage.sync.get(["geminiApiKey"]);if(!e)throw new Error("No Prompt API and no Gemini key set in Settings.");const n=`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${encodeURIComponent(e)}`,i=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{role:"user",parts:[{text:a}]}]})});if(!i.ok){const m=await i.text();throw new Error(`Gemini error ${i.status}: ${m}`)}const o=await i.json();return((d=(y=(l=(u=(c=o==null?void 0:o.candidates)==null?void 0:c[0])==null?void 0:u.content)==null?void 0:l.parts)==null?void 0:y[0])==null?void 0:d.text)||""||"[no response]"}async function x(){const a=await chrome.tabs.query({currentWindow:!0}),e=[];for(const t of a){if(!t.id)continue;const n=await f(t.id);if(n){const r=await g(`Summarize in 2 bullets. Title: ${n.title}

Content: ${n.text.slice(0,4e3)}`);e.push(`- ${n.title}:
${r}`)}}return e.join(`

`)}function f(a){return new Promise(e=>{chrome.tabs.sendMessage(a,{type:"get_page_text"},t=>{if(!(t!=null&&t.ok))return e(null);e({title:t.title,text:t.text})})})}
